<p>Se mostrarmos os 5 primeiros registros da tabela de funcionários do esquema <strong>HR</strong></p><blockquote><p><code>SELECT EMPLOYEE_ID, FIRST_NAME, LAST_NAME, MANAGER_ID<br /> DE funcionários <br />PEÇA SOMENTE AS PRIMEIRAS 5 LINHAS;</code></p></blockquote><table align="center" border="1" summary="Resultados da consulta"><tbody><tr> <th style="background-color:#9e9e9e; text-align:center">EMPLOYEE_ID</th><th style="background-color:#9e9e9e; text-align:center">FIRST_NAME</th><th style= "background-color:#9e9e9e; text-align:center">LAST_NAME</th><th style="background-color:#9e9e9e; text-align:center">MANAGER_ID</th></tr> <tr ><td>100</td><td>Steven</td><td>Rei</td><td>-</td></tr><tr><td>101</td> <td >Neena</td><td>Kochhar</td><td>100</td></tr><tr><td>102</td><td>Lex</td><td> De Haan </td><td>100</td></tr><tr><td>103</td><td>Alexander</td><td>Hunold</td><td>102< /td ></tr><tr><td>104</td><td>Bruce</td><td>Ernst</td><td>103</td></tr></tbody> </ table><p>podemos ver que existem relacionamentos hierárquicos entre esses registros: <code>Steven King</code> é o superior hierárquico de <code>Lex De Haan</code> e ele, por sua vez, é o superior hierárquico de <code>Alexander Hunold</code>.</p ><p>O PostgreSQL nos permite consultar os relacionamentos hierárquicos existentes entre os registros da tabela.</p><h3>Consultas com <code>WITH</code></h3><p>Para abordar consultas hierárquicas com PostgreSQL, primeiro devemos conhecer a operação básica de <code>WITH</code></p><p><code>WITH</code> permite escrever instruções auxiliares para usá-las em grandes consultas. Essas instruções, que geralmente são chamadas de <code>Common Table Expressions</code> ou <acronym class="acronym">CTE</acronym>s, podem ser interpretadas como tabelas definidas temporariamente que existem para uma única consulta. Cada instrução auxiliar em uma cláusula <code>WITH</code> pode ser um <code>SELECT</code>, <>INSERT</code>, <code>UPDATE</code> ou <code>DELETE</ código>; e a própria cláusula <code>WITH</code> está associada à consulta principal que também pode ser um <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code> , ou <code>DELETE</code>.</p><h3>Exemplo <code>COM</code></h3><blockquote><p><code>COM CEO AS (SELECT * FROM employees WHERE MANAGER_ID IS NULL)<br />SELECT FIRST_NAME, LAST_NAME FROM employees WHERE MANAGER_ID IN (SELECT EMPLOYEE_ID FROM CEO);</code></p></blockquote><blockquote><pre> first_name | last_name ------------+----------- Neena | Kochhar Lex | De Haan Den | Rafael Mateus | Weiss-Adam | Fripp Payam | Kaufling Shanta | VollmanKevin | João Mourgos | RussellKaren | Alberto Parceiros | Errazuriz Geraldo | Cambrault Eleni | Zlotkey Michael | Hartstein (14 linhas) </pre></blockquote><h3>Exemplo de consulta hierárquica:</h3><blockquote><pre><code> WITH RECURSIVE managers AS ( SELECT EMPLOYEE_ID, FIRST_NAME, LAST_NAME, 1::integer LEVEL FROM employees WHERE MANAGER_ID IS NULL -- Root é o funcionário com o campo manager_id como NULL UNION ALL SELECT subordinados.employee_id, subordinados.first_name, subordinados.last_name, managers.level + 1 FROM empregados subordinados JOIN managers ON managers.EMPLOYEE_ID = subordinados. -- Como descer a hierarquia ) SELECT CONCAT(LPAD(' ', 10 * (LEVEL - 1), '-'),EMPLOYEE_ID) AS "HIERARCHICAL_LEVEL", FIRST_NAME, LAST_NAME FROM managers;-- Mostrar para eles < / código></pre></blockquote><blockquote><pre> HIERARCHICAL_LEVEL | first_name | last_name ------------------------------------+------------ - +------------- 100 | Steve | Rei --------- 101 | querida | Kochhar --------- 102 | lex | De Haan --------- 114 | dar | Raphaely --------- 120 | Mateus | Weiss --------- 121 | Adão | Fripp --------- 122 | Pagamento | Kaufling --------- 123 | Shanta | Vollmann --------- 124 | Kevin | Mourgos --------- 145 | João | Russel --------- 146 | Karen | Parceiros --------- 147 | Alberto | Errazuriz --------- 148 | Geraldo | Cambrault --------- 149 | Elena | Zlotkey --------- 201 | Miguel | Hartstein ------------------- 103 | Alexandre | Hunold ------------------- 108 | Nancy | Greenberg ------------------- 115 | Alexandre | Khoo </pre></blockquote><h3>Exercício:</h3><p>Mostra os relacionamentos hierárquicos existentes que começam com funcionários do departamento chamado '<code>TI</code>'.</p>